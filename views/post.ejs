<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= blog ? blog.title : 'Post Not Found' %> ‚Äî Inkwell</title>
  <link rel="stylesheet" href="/styles/styles.css" />
</head>
<body>

  <%- include("./includes/header.ejs") %>

  <main>
    <% if (blog) { %>
      <!-- ‚îÄ‚îÄ Hero Image ‚îÄ‚îÄ -->
      <div class="post-hero" role="img" aria-label="<%= blog.title %> hero image" 
           style="height:440px; background:linear-gradient(135deg,#EDE8E3,#C8BFB6); display:flex; align-items:center; justify-content:center; font-size:5rem; color:#B0A898;">
        <% if (blog.image) { %>
          <img src="<%= blog.image %>" alt="<%= blog.title %>" style="width:100%; height:100%; object-fit:cover;">
        <% } else { %>
          <!-- Fallback emoji based on category -->
          <%= 
            blog.category === 'Tech' ? 'üíª' : 
            blog.category === 'Life' ? 'üåø' : 
            blog.category === 'Design' ? '‚úèÔ∏è' : 
            blog.category === 'Travel' ? '‚úàÔ∏è' : 
            blog.category === 'Food' ? 'üç≥' : 
            blog.category === 'Finance' ? 'üí∞' : 'üìù'
          %>
        <% } %>
      </div>

      <!-- ‚îÄ‚îÄ Post Header ‚îÄ‚îÄ -->
      <header class="post-header">
        <!-- Category Badge -->
        <span class="badge badge-<%= blog.category.toLowerCase() %>"><%= blog.category %></span>

        <!-- Title -->
        <h1 class="post-title">
          <%= blog.title %>
        </h1>

        <!-- Byline -->
        <div class="post-byline">
          <div class="author-avatar" aria-hidden="true">
            <%= blog.author ? blog.author.charAt(0).toUpperCase() : 'A' %>
          </div>
          <div class="byline-text">
            <span class="byline-author"><%= blog.author || 'Anonymous' %></span>
            <time class="byline-date" datetime="<%= blog.createdAt.split('T')[0] %>">
              <%= new Date(blog.createdAt).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              }) %>
            </time>
          </div>
          <span class="post-reading-time"><%= blog.readingTime || '5' %> min read</span>
        </div>
      </header>

      <!-- ‚îÄ‚îÄ Post Content ‚îÄ‚îÄ -->
      <article class="post-content">
        <%= blog.content.replace(/\n/g, '<br>') %>
      </article>

      <!-- ‚îÄ‚îÄ Like & Share ‚îÄ‚îÄ -->
      <div class="post-interactions">
        <!-- Like Button ‚Äî JS handles the toggle animation in script.js -->
        <button
          class="like-btn"
          aria-label="Like this post. <%= blog.likes || 0 %> likes."
          type="button"
          data-post-id="<%= blog.id %>"
        >
          <span class="heart" aria-hidden="true">‚ù§Ô∏è</span>
          <span class="like-count"><%= blog.likes || 0 %></span>
          <span>Likes</span>
        </button>

        <div class="share-actions">
          <span>Share:</span>
          <button type="button" onclick="copyToClipboard()" id="copyLinkBtn">Copy Link</button>
          <button type="button" onclick="shareOnTwitter()">Twitter</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Comments Section ‚îÄ‚îÄ -->
      <section class="comments-section" aria-labelledby="comments-heading">
        <h2 class="section-title" id="comments-heading">Comments</h2>
        <div class="divider"></div>

        <!-- Comment Form -->
        <div class="comment-form">
          <h3 style="font-size:1rem; font-weight:600; color:var(--color-text); margin-bottom:18px;">Leave a comment</h3>
          <form action="/post/<%= blog.id %>/comment" method="POST" novalidate id="commentForm">
            <div class="form-row">
              <div class="form-group">
                <label for="comment-name">Name</label>
                <input
                  type="text"
                  id="comment-name"
                  name="name"
                  class="form-control"
                  placeholder="Your name"
                  required
                  autocomplete="name"
                />
              </div>
              <div class="form-group">
                <label for="comment-email">Email <span style="font-weight:400;opacity:.6">(optional)</span></label>
                <input
                  type="email"
                  id="comment-email"
                  name="email"
                  class="form-control"
                  placeholder="you@example.com"
                  autocomplete="email"
                />
              </div>
            </div>
            <div class="form-group" style="margin-bottom:20px;">
              <label for="comment-text">Comment</label>
              <textarea
                id="comment-text"
                name="comment"
                class="form-control"
                rows="4"
                placeholder="Share your thoughts‚Ä¶"
                required
              ></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Post Comment</button>
          </form>
        </div>

        <!-- Existing Comments -->
        <% if (blog.comments && blog.comments.length > 0) { %>
          <ul class="comments-list" aria-label="Existing comments">
            <% blog.comments.forEach(comment => { %>
              <li class="comment-item">
                <div class="comment-header">
                  <div class="comment-avatar" aria-hidden="true">
                    <%= comment.name ? comment.name.charAt(0).toUpperCase() : 'A' %>
                  </div>
                  <span class="comment-author"><%= comment.name %></span>
                  <time class="comment-date" datetime="<%= comment.createdAt %>">
                    <%= new Date(comment.createdAt).toLocaleDateString('en-US', { 
                      month: 'short', 
                      day: 'numeric', 
                      year: 'numeric' 
                    }) %>
                  </time>
                </div>
                <p class="comment-body">
                  <%= comment.text %>
                </p>
              </li>
            <% }); %>
          </ul>
        <% } else { %>
          <p style="text-align: center; color: var(--color-text-muted); padding: 2rem;">
            No comments yet. Be the first to share your thoughts!
          </p>
        <% } %>
      </section>
    <% } else { %>
      <!-- Post not found -->
      <div class="not-found-page" style="min-height: 60vh;">
        <div class="not-found-inner">
          <span class="not-found-number">404</span>
          <h1>Post Not Found</h1>
          <p>The article you're looking for doesn't exist or has been moved.</p>
          <a href="/" class="btn btn-primary">‚Üê Back to Home</a>
        </div>
      </div>
    <% } %>
  </main>

  <%- include("./includes/footer.ejs") %>

  <script>
    // Copy link functionality
    function copyToClipboard() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        const btn = document.getElementById('copyLinkBtn');
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }).catch(() => {
        alert('Failed to copy link');
      });
    }

    // Share on Twitter
    function shareOnTwitter() {
      const text = encodeURIComponent(document.querySelector('.post-title').textContent);
      const url = encodeURIComponent(window.location.href);
      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
    }

    // Like button functionality (enhanced)
    document.addEventListener('DOMContentLoaded', () => {
      const likeBtn = document.querySelector('.like-btn');
      
      if (likeBtn) {
        const likeCount = likeBtn.querySelector('.like-count');
        const postId = likeBtn.dataset.postId;
        let liked = localStorage.getItem(`liked-${postId}`) === 'true';
        let count = parseInt(likeCount?.textContent, 10) || 0;

        // Set initial state
        if (liked) {
          likeBtn.classList.add('liked');
        }

        likeBtn.addEventListener('click', async () => {
          liked = !liked;
          
          // Optimistic update
          likeBtn.classList.toggle('liked', liked);
          likeBtn.classList.remove('pop');
          void likeBtn.offsetWidth;
          likeBtn.classList.add('pop');
          
          count = liked ? count + 1 : count - 1;
          if (likeCount) likeCount.textContent = count;
          
          // Save to localStorage
          localStorage.setItem(`liked-${postId}`, liked);
          
          // Update aria-label
          likeBtn.setAttribute(
            'aria-label',
            liked ? `Unlike this post. ${count} likes.` : `Like this post. ${count} likes.`
          );

          // Remove animation class after it completes
          likeBtn.addEventListener('animationend', () => {
            likeBtn.classList.remove('pop');
          }, { once: true });

          // Here you would typically also send a request to your server
          // to update the like count in the database
          try {
            await fetch(`/post/${postId}/like`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ liked })
            });
          } catch (error) {
            console.error('Failed to sync like:', error);
            // Revert on error
            liked = !liked;
            likeBtn.classList.toggle('liked', liked);
            count = liked ? count + 1 : count - 1;
            if (likeCount) likeCount.textContent = count;
            localStorage.setItem(`liked-${postId}`, liked);
          }
        });
      }

      // Comment form validation
      const commentForm = document.getElementById('commentForm');
      if (commentForm) {
        commentForm.addEventListener('submit', (e) => {
          const name = document.getElementById('comment-name').value.trim();
          const comment = document.getElementById('comment-text').value.trim();
          
          if (!name || !comment) {
            e.preventDefault();
            alert('Please fill in all required fields');
          }
        });
      }
    });
  </script>

  <script src="/scripts/script.js"></script>
</body>
</html>